<h1 id="common-gotchas-when-mutating-a-slice">Common gotchas when mutating a slice</h1>

<p>Mutating slices in Go can be a bit confusing.</p>

<p>It’s generally known that slices are a reference an underlying array. But when it comes to mutating a slice, there are some very common gotchas that can trip you up. Let’s look at three scenarios.</p>

<h2 id="from-inside-a-function">From inside a function</h2>
<p>In Go, all variables are passed by value, meaning the function body will receive a copy.</p>

<p>When you pass a slice to a function, the variable (slice descriptor), is a <strong>copy of the caller’s reference</strong> to the underlying array (by <code class="highlighter-rouge">caller</code> I mean the place where the function is being called).</p>

<p>So if you try to append to the slice inside the function, you are actually appending to a duplicate of the original reference. The caller’s slice will remain unaffected.</p>

<p>In the example below, we try to append a value to a slice, using the <code class="highlighter-rouge">addNum</code> function. Unfortunately, after calling <code class="highlighter-rouge">addNum</code>, the slice hasn’t changed.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c">// THIS WON'T WORK</span><span class="x">
</span><span class="n">mySlice</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">addNum</span><span class="x"> </span><span class="p">(</span><span class="n">s</span><span class="x"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">,</span><span class="x"> </span><span class="n">num</span><span class="x"> </span><span class="kt">int</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">s</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="x"> </span><span class="n">num</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">addNum</span><span class="p">(</span><span class="n">mySlice</span><span class="p">,</span><span class="x"> </span><span class="m">4</span><span class="p">)</span><span class="x">

</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">mySlice</span><span class="p">)</span><span class="x">

</span><span class="c">// --&gt; [1 2 3]</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>To successfully append to the slice, the function must return its copy of the slice. You then assign it to the original slice.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">mySlice</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">addNum</span><span class="x"> </span><span class="p">(</span><span class="n">s</span><span class="x"> </span><span class="p">[]</span><span class="kt">int</span><span class="p">,</span><span class="x"> </span><span class="n">num</span><span class="x"> </span><span class="kt">int</span><span class="p">)</span><span class="x"> </span><span class="p">[]</span><span class="kt">int</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="x"> </span><span class="n">num</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">mySlice</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">addNum</span><span class="p">(</span><span class="n">mySlice</span><span class="p">,</span><span class="x"> </span><span class="m">4</span><span class="p">)</span><span class="x">

</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">mySlice</span><span class="p">)</span><span class="x">

</span><span class="c">// --&gt; [1 2 3 4]</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="from-inside-a-for-loop">From inside a for-loop</h2>
<p>When ranging over a slice, the variable referencing each value points to <strong>a copy of the value</strong>. If you try to mutate the value at a given index with this variable, it will not work. Once you leave the scope of the for-loop, you’ll find the slice was unaffected.</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c">// THIS WON'T WORK</span><span class="x">
</span><span class="n">somePeople</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"Ada"</span><span class="p">,</span><span class="x"> </span><span class="s">"Grace"</span><span class="p">,</span><span class="x"> </span><span class="s">"Charles"</span><span class="p">}</span><span class="x">

</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">name</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">somePeople</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">name</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">ToUpper</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">somePeople</span><span class="p">)</span><span class="x">

</span><span class="c">// --&gt; ["Ada" "Grace" "Charles"]</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>
<p>For the mutation to stick, you must use bracket notation instead:</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">somePeople</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"Ada"</span><span class="p">,</span><span class="x"> </span><span class="s">"Grace"</span><span class="p">,</span><span class="x"> </span><span class="s">"Charles"</span><span class="p">}</span><span class="x">

</span><span class="k">for</span><span class="x"> </span><span class="n">i</span><span class="p">,</span><span class="x"> </span><span class="n">name</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">somePeople</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">somePeople</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">ToUpper</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">somePeople</span><span class="p">)</span><span class="x">

</span><span class="c">// --&gt; ["ADA" "GRACE" "CHARLES"]</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="when-using-variables">When using variables</h2>
<p>This is similar to the for-loop example. Any changes to a slice require the use of bracket notation. <strong>Variables will point to copies of the value</strong> at a given index, meaning any changes to that variable will not affect the slice.</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="c">// THIS WON'T WORK</span><span class="x">
</span><span class="k">type</span><span class="x"> </span><span class="n">food</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">name</span><span class="x">   </span><span class="kt">string</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">pantry</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="n">food</span><span class="p">{</span><span class="x">
	</span><span class="p">{</span><span class="n">name</span><span class="o">:</span><span class="x"> </span><span class="s">"banana"</span><span class="p">},</span><span class="x">
	</span><span class="p">{</span><span class="n">name</span><span class="o">:</span><span class="x"> </span><span class="s">"satsuma"</span><span class="p">},</span><span class="x">
	</span><span class="p">{</span><span class="n">name</span><span class="o">:</span><span class="x"> </span><span class="s">"kiwi"</span><span class="p">},</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">toChange</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">pantry</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="x"> </span><span class="c">// this makes a copy!</span><span class="x">
</span><span class="n">toChange</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">food</span><span class="p">{</span><span class="n">name</span><span class="o">:</span><span class="x"> </span><span class="s">"strawberry"</span><span class="p">}</span><span class="x">

</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">pantry</span><span class="p">)</span><span class="x">

</span><span class="c">// --&gt; [{banana} {satsuma} {kiwi}]</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>
<p>With bracket notation, it works.</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">type</span><span class="x"> </span><span class="n">food</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">name</span><span class="x">   </span><span class="kt">string</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">pantry</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="n">food</span><span class="p">{</span><span class="x">
	</span><span class="p">{</span><span class="n">name</span><span class="o">:</span><span class="x"> </span><span class="s">"banana"</span><span class="p">},</span><span class="x">
	</span><span class="p">{</span><span class="n">name</span><span class="o">:</span><span class="x"> </span><span class="s">"satsuma"</span><span class="p">},</span><span class="x">
	</span><span class="p">{</span><span class="n">name</span><span class="o">:</span><span class="x"> </span><span class="s">"kiwi"</span><span class="p">},</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">pantry</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">food</span><span class="p">{</span><span class="n">name</span><span class="o">:</span><span class="x"> </span><span class="s">"strawberry"</span><span class="p">}</span><span class="x">

</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">pantry</span><span class="p">)</span><span class="x">

</span><span class="c">// --&gt; [{banana} {satsuma} {strawberry}]</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>
