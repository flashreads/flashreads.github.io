<h1 id="persistent-data-structures">Persistent Data Structures</h1>

<p>Persistent data structures are <a href="https://en.wikipedia.org/wiki/Data_structure">data structures</a> that preserve the previous versions of the structure on modification.
They are effectively immutable, and depending on the implementation offer a special kind of memory optimization.</p>

<p>Being immutable, the persistent data structures are useful when writing concurrent code and the need arises to use some kind of data structure like list, tree, map or other.</p>

<p>When a persistent structure is modified, the original structure remains unchanged (it is a previous version), and the modification method returns a new structure that contains the modification.</p>

<p>Consider the following list:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>a: 1 -&gt; 2 -&gt; 3
</pre></td></tr></tbody></table></code></pre></div></div>

<p>if we add another element to it, the list itself is modified:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>a := add(a, 4)
a: 1 -&gt; 2 -&gt; 3 -&gt; 4
</pre></td></tr></tbody></table></code></pre></div></div>

<p>However if we use a persistent list, then the same operation would look like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>a: 1 -&gt; 2 -&gt; 3
b := persistent_list_add(a, 4)

print(a)
1 -&gt; 2 -&gt; 3

print(b)
1 -&gt; 2 -&gt; 3 -&gt; 4
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The method that adds an element to the list, actually returns a new list, containing the element we added.
The original list remains unchanged.</p>

<p>There are multiple ways that this can be achieved:</p>

<ul>
  <li>Doing copy-on-write - we copy the entire list in <code class="highlighter-rouge">b</code> then actually add the element, leaving the original list <code class="highlighter-rouge">a</code> unchanged.
This however is not very memory efficient, as every modification would allocate memory for all previous elements - <code class="highlighter-rouge">O(n^2)</code> space complexity.</li>
  <li>Using a linked list, but we only keep the pointer to the head and the tail of the list. This way we can share the unmodified elements and
optimize the memory usage.</li>
</ul>

<p>Let’s consider the second way of implementing this data structure. We want to reuse the elements from <code class="highlighter-rouge">a</code> and just add the final element.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>a: head a           tail a
   \                   |
    +-&gt; (1) -&gt; (2) -&gt; (3)
   /                    \
b: head b                +-&gt; (4) tail b
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="highlighter-rouge">a</code> and <code class="highlighter-rouge">b</code> share the first 3 elements, but only <code class="highlighter-rouge">b</code> can “see” the final added element.</p>

<p>When removing or updating an element, then we’re only copying the list up to the affected elements.
Let’s say we want to update the second element. Then we have to copy the head and the second element:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>a: head a           tail a
   \                   |
    +-&gt; (1) -&gt; (2) -&gt; (3)
   /               /    \
b: head b         /      +-&gt; (4) tail b and c
                 /
    (1) -&gt; (7) -+
     |
c: head c
</pre></td></tr></tbody></table></code></pre></div></div>

<p>After changing the element <code class="highlighter-rouge">2</code> to <code class="highlighter-rouge">7</code>, we have to copy all affected elements, but the rest of the list
remains unchanged and shared between the previous versions. Note that all changes return new versions of the
list and we cannot directly modify previous versions - <code class="highlighter-rouge">a</code> and <code class="highlighter-rouge">b</code> remain unchanged after we do <code class="highlighter-rouge">set(b, 2, 7)</code>.</p>

<h2 id="an-example-of-persistent-list-in-python">An example of persistent list in Python</h2>

<p>Let’s implement this kind of structure in Python. Every list would contain nodes that hold the data
and point to the next node. The list itself will contain the HEAD and TAIL nodes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="nb">next</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">PList</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">head</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">tail</span>
    
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s">'''Adds to the end of the list.
        '''</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PList</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>  <span class="c1"># Add first element in an empty list
</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="nb">next</span> <span class="o">=</span> <span class="n">node</span>

        <span class="c1"># Return the new list
</span>        <span class="k">return</span> <span class="n">PList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'''Removes the last element from the list.
        '''</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Cannot pop from empty list'</span><span class="p">)</span>
        
        <span class="n">tail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span>
        <span class="k">while</span> <span class="n">tail</span><span class="o">.</span><span class="nb">next</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="n">tail</span><span class="o">.</span><span class="nb">next</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">PList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s">'''Updates the element at index and returns the updated list.
        '''</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Empty list.'</span><span class="p">)</span>
        
        <span class="n">lst</span> <span class="o">=</span> <span class="n">PList</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">index</span> <span class="ow">and</span> <span class="n">node</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="nb">next</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">index</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Index out of bounds'</span><span class="p">)</span>
        
        <span class="n">lst</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">lst</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="nb">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="nb">next</span>
        
        <span class="k">return</span> <span class="n">PList</span><span class="p">(</span><span class="n">lst</span><span class="o">.</span><span class="n">head</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="s">'''Removes the element at index.
        '''</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Cannot remove from empty list'</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">PList</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Index out of bounds'</span><span class="p">)</span>

        <span class="n">lst</span> <span class="o">=</span> <span class="n">PList</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="nb">next</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Index out of bounds'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="nb">next</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
            <span class="c1"># Actually pop
</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        
        <span class="n">tail</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="n">tail</span>
        <span class="n">tail</span><span class="o">.</span><span class="nb">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="nb">next</span>
        
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">PList</span><span class="p">(</span><span class="n">lst</span><span class="o">.</span><span class="n">head</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'''Returns an iterable (iterator) that goes through all elements of the list.
        '''</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span>
        <span class="k">while</span> <span class="n">node</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>  <span class="c1"># we must terminate at the tail of the list.
</span>            <span class="k">yield</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="nb">next</span>
        <span class="k">yield</span> <span class="n">node</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'[]'</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate</span><span class="p">()])</span>


<span class="n">a</span> <span class="o">=</span> <span class="n">PList</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Lists a and b after adding element to a:'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'a:'</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'b:'</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="n">value</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">Lists after removing element from b:'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'a:'</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'b:'</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'c:'</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="s">'(removed '</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s">')'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">Lists after updating element in b:'</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'a:'</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'b:'</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'c:'</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'d:'</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>After execution, it will print:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>Lists a and b after adding element to a:
a: [1, 2, 3]
b: [1, 2, 3, 4]

Lists after removing element from b:
a: [1, 2, 3]
b: [1, 2, 3, 4]
c: [1, 3, 4] (removed  2 )

Lists after updating element in b:
a: [1, 2, 3]
b: [1, 2, 3, 4]
c: [1, 3, 4]
d: [1, 7, 3, 4]
</pre></td></tr></tbody></table></code></pre></div></div>

<p>which is exactly what we intended and wanted - every list is immutable and we can add/remove/update elements and
by doing so we get new lists.</p>
