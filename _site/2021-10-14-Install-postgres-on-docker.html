<h1 id="postgresql-database-in-docker">PostgreSQL database in Docker</h1>

<p>Sometimes it is needed to have a local copy of production database or to have a specific pgsql version for dev and test purposes. This small guide will help with it.</p>

<h2 id="steps-to-reproduce">Steps to reproduce</h2>

<p>Create local folder for database files:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ mkdir /var/postgres-data/
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Or you could use path like ${HOME}/postgres-data/, your choise.</p>

<p>Now we start container by command:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>$ docker run -d \
	--name pgsql_for_website \
	-
	-e POSTGRES_PASSWORD=Password312 \
	-v /var/postgres-data/:/var/lib/postgresql/data \
        -p 5432:5432
        postgres
</pre></td></tr></tbody></table></code></pre></div></div>

<p>OR you could create dockerfile for PostgreSQL container. Something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>version: '3.7'
services:
  db:
    container_name: pgsql_for_website
    image: postgres:12-alpine
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Password312
      POSTGRES_DB: pgdb
    volumes:
      - /var/postgres-data:/var/lib/postgresql/data/
</pre></td></tr></tbody></table></code></pre></div></div>

<p>and run it:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ docker-compose -f compose-postgresql.yml up -d
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Check that container is running:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ docker ps
</pre></td></tr></tbody></table></code></pre></div></div>
<p>If you have a lot of containers in output, use grep:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ docker ps | grep postgre
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Output will be like:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>$ docker ps | grep postgre
d63fe2debc4e      postgres:12-alpine      "docker-entrypoint.sâ€¦"   5 min ago      Up 5 min      0.0.0.0:5432-&gt;5432/tcp   pgsql_for_website
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Connect to pgsql container with bash and then psql:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>$ docker exec -it pgsql_for_website bash
$ psql -h localhost -U postgres
</pre></td></tr></tbody></table></code></pre></div></div>

<p>To migrate database from other database you need to create a DB dump:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ pg_dump --username [username] [database name] &gt; pgdump.sql
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And restore it to created container as it would be done to any PostgreSQL server:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ psql -h [host with pgsql container address] -d [database name] --username [username] -f pgdump.sql
</pre></td></tr></tbody></table></code></pre></div></div>
<p>In our case it would be:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ psql -h [host with pgsql container address] -d pgdb --username postgres -f pgdump.sql
</pre></td></tr></tbody></table></code></pre></div></div>

<p>At last, connection string would looks like:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>postgres://postgres:Password312@[host with pgsql container address]:5432/pgdb
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And for deletion you could use next commands:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>$ docker container stop pgsql_for_website 
$ docker container rm pgsql_for_website
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Or</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ docker container rm -f pgsql_for_website
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Output would contain deleted container name.</p>
