<h1 id="undo-the-latest-local-commit-in-git">Undo the latest local commit in Git</h1>

<p>So we’ve committed some changes by mistake and we want to revert it back. No worries, Git is here to help!</p>

<p>Depending on what we need, we can do one of the following:</p>

<h2 id="undo-all-changes-in-the-last-commit">Undo all changes in the last commit</h2>

<p>To undo all changes made in the last commit, and go back to an earlier commit, we
can use <code class="highlighter-rouge">git revert</code>.</p>

<p>Let’s say we have some repository, and we committed something by mistake:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>git log <span class="nt">--oneline</span> 
cba9069 <span class="o">(</span>HEAD -&gt; master<span class="o">)</span> Oops, this change is a mistake  &lt;<span class="nt">--</span> We want to revert this commit
5b7794b Some stable changes
e57b197 Adds some content
187ea9d Initial commit

</pre></td></tr></tbody></table></code></pre></div></div>

<p>Then, to revert the latest commit, we can use <code class="highlighter-rouge">git revert &lt;commit sha&gt;</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git revert cba9069
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This will pop up our favorite editor to enter the revert commit message and will create
a new commit, which reverts <strong>all</strong> changes in the given commit.</p>

<p>After the command is complete, the repository history will look like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>git log <span class="nt">--oneline</span> 
0ed5618 <span class="o">(</span>HEAD -&gt; master<span class="o">)</span> Revert <span class="s2">"Oops, this change is a mistake"</span>   &lt;<span class="nt">--</span> this reverts all changes from cba9069
cba9069 Oops, this change is a mistake
5b7794b Some stable changes   &lt;<span class="nt">--</span> The final state of the repository will be the same as <span class="k">in </span>this commit
e57b197 Adds some content
187ea9d Initial commit
</pre></td></tr></tbody></table></code></pre></div></div>

<p>As you can see, there is an additional commit that reverted our changes and the final state of the repository is
the same as the state it had in the previous commit (the commit before the one we wanted to revert).</p>

<p>This is useful when we want to keep the repository history and it is the recommended way of doing things. The upside
is that we haven’t lost any data, even if we change our mind later, we can always revert again or see the changes in the
reverted commit - it’s all there in the history.</p>

<h2 id="reset-the-changes-modify-and-commit-again">Reset the changes, modify and commit again</h2>

<p>Sometimes we don’t want to revert everything, but instead we need to make just a couple of changes and commit again.</p>

<p>In these situations we can use <code class="highlighter-rouge">git reset --soft &lt;commit-ref&gt;</code>:</p>

<p>Given the same state of the repository:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>$ git log --oneline 
cba9069 (HEAD -&gt; master) Oops, this change is a mistake  &lt;-- We want to make some changes here again and commit
5b7794b Some stable changes
e57b197 Adds some content
187ea9d Initial commit

</pre></td></tr></tbody></table></code></pre></div></div>

<p>Then we can do:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git reset <span class="nt">--soft</span> HEAD^
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This makes a soft reset to the commit that is parent of the current HEAD (the current HEAD is what we want to change).
Soft reset means that Git will undo the changes of the commit in the following way:</p>

<ul>
  <li>The HEAD of the repository will now point to <code class="highlighter-rouge">5b7794b Some stable changes</code> (HEAD^ - one up from current HEAD)</li>
  <li>The changes introduced in the faulty commit are not lost, but are staged in the repository</li>
</ul>

<p>This gives us the opportunity to redo the changes and commit again.
Doing a <code class="highlighter-rouge">git status</code> to see the changes we see something like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>git status 
On branch master
Changes to be committed:
  <span class="o">(</span>use <span class="s2">"git restore --staged &lt;file&gt;..."</span> to unstage<span class="o">)</span>
	modified:   README.md

</pre></td></tr></tbody></table></code></pre></div></div>

<p>And the history log:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>git log <span class="nt">--oneline</span> 
5b7794b <span class="o">(</span>HEAD -&gt; master<span class="o">)</span> Some stable changes
e57b197 Adds some content
187ea9d Initial commit

</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is exactly what we wanted. After doing the changes we can commit:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Fixed the commit"</span>

<span class="nv">$ </span>git log <span class="nt">--oneline</span>
55293e6 <span class="o">(</span>HEAD -&gt; master<span class="o">)</span> Fixed the commit
5b7794b Some stable changes
e57b197 Adds some content
187ea9d Initial commit

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="getting-rid-of-the-commit-completely">Getting rid of the commit completely</h2>

<p>Sometimes we want to get rid of the commit completely. Maybe we have committed some sensitive data by mistake (like 
an access key or password), and we want no trace of it in the history. In those cases, we can rebase the branch and 
drop the commits we don’t want.</p>

<p>Again starting with the same repository, we can rebase on the parent commit of the good commit (going 2 commits back, 
because we cannot drop a commit if there is just one commit in the rebase list):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>git log <span class="nt">--oneline</span> 
cba9069 <span class="o">(</span>HEAD -&gt; master<span class="o">)</span> Oops, this change is a mistake  &lt;<span class="nt">--</span> We want this gone
5b7794b Some stable changes
e57b197 Adds some content &lt;<span class="nt">--</span> we pass this commit to the rebase <span class="nb">command</span>, so we have 2 commits <span class="k">in </span>the list
187ea9d Initial commit

</pre></td></tr></tbody></table></code></pre></div></div>

<p>Rebase:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git rebase <span class="nt">-i</span> e57b197
</pre></td></tr></tbody></table></code></pre></div></div>

<p>In the rebase editor:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>pick 5b7794b Some stable changes  &lt;-- we want to keep this
drop cba9069 Oops, this change is a mistake &lt;-- but we want to drop this
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Save, and commit.</p>

<p>The final state of the repository:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>git log <span class="nt">--oneline</span> 
5b7794b <span class="o">(</span>HEAD -&gt; master<span class="o">)</span> Some stable changes
e57b197 Adds some content
187ea9d Initial commit
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And there are no changes staged for commit:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>$ git status 
On branch master
nothing to commit, working tree clean
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Important Note:</strong> This will completely remove any trace of the commit, so once done, it is very hard to get 
those changes back if we change our mind later on. We should use this approach only if we are <strong>certain</strong> that we
want that commit completely gone.</p>

<h2 id="final-notes">Final notes</h2>

<p>When using approaches 2 and 3 (using <code class="highlighter-rouge">reset</code> and <code class="highlighter-rouge">rebase</code>), we’re making changes in the repository graph itself. While
locally this is absolutely fine, there might be a problem when we’re having a remote repository.
When the commit we want to revert is on the remote repository as well, then the two repositories will have different
graphs and we cannot <code class="highlighter-rouge">push</code> our changes in a straight forward manner without Git complaining that the branches 
have diverged.</p>

<p>Approach 1 however, when using <code class="highlighter-rouge">git revert</code>, adds an additional commit, just like a regular commit, which then can
be easily pushed to the remote repository.</p>
